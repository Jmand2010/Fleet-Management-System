<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management & Maintenance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1B4332, #2D6A4F);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .company-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #1B4332;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .login-header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1B4332;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 134, 171, 0.3);
        }

        /* Hide main app initially */
        .main-app {
            display: none;
        }

        .main-app.show {
            display: block;
        }

        /* Rest of the styles from original */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: #2E86AB;
            color: #2E86AB;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .app-form-group {
            display: flex;
            flex-direction: column;
        }

        .app-form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #1B4332;
        }

        .app-form-group input,
        .app-form-group select,
        .app-form-group textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .app-form-group input:focus,
        .app-form-group select:focus,
        .app-form-group textarea:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        .data-table th {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.active {
            background: #DCFCE7;
            color: #166534;
        }

        .status.maintenance {
            background: #FEF3C7;
            color: #92400E;
        }

        .status.repair {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status.inactive {
            background: #F3F4F6;
            color: #6B7280;
        }

        .status.dot {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(46, 134, 171, 0.3);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .maintenance-due {
            background: linear-gradient(135deg, #DC2626, #EF4444) !important;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-filter input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            min-width: 200px;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #DC2626, #EF4444);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #0284C7, #0EA5E9);
            color: white;
            font-size: 14px;
            padding: 8px 20px;
        }

        .export-btn {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            max-width: 400px;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 5px solid #2E86AB;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left-color: #DC2626;
        }

        .notification.success {
            border-left-color: #059669;
        }

        .notification .notification-title {
            font-weight: 600;
            color: #1B4332;
            margin-bottom: 8px;
        }

        .notification .notification-message {
            color: #666;
            font-size: 14px;
        }

        .notification .notification-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>ðŸš› Fleet Manager</h1>
                <p>Multi-Tenant Fleet Management System</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label>Company Code</label>
                    <input type="text" id="companyCode" required placeholder="Enter company code (e.g. ACME_TRUCKING)">
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <div class="company-info">
                    <div id="companyName">Demo Fleet Solutions</div>
                    <div id="userName">User</div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
                <h1>ðŸš› Fleet Management System</h1>
                <p>Complete equipment tracking and maintenance management</p>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="showTab('equipment')">Equipment</button>
                <button class="nav-tab" onclick="showTab('maintenance')">Maintenance</button>
                <button class="nav-tab" onclick="showTab('reports')">Reports</button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h3 id="totalEquipment">0</h3>
                        <p>Total Equipment</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeEquipment">0</h3>
                        <p>Active Equipment</p>
                    </div>
                    <div class="stat-card maintenance-due">
                        <h3 id="maintenanceDue">0</h3>
                        <p>Maintenance Due</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalMaintenanceRecords">0</h3>
                        <p>Maintenance Records</p>
                    </div>
                </div>

                <h2>Recent Maintenance Activities</h2>
                <table class="data-table" id="recentMaintenanceTable">
                    <thead>
                        <tr>
                            <th>Equipment</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Cost</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="equipment" class="tab-content">
                <h2>Add New Equipment</h2>
                <form id="equipmentForm">
                    <div class="form-grid">
                        <div class="app-form-group">
                            <label>Equipment ID *</label>
                            <input type="text" id="equipmentId" required>
                        </div>
                        <div class="app-form-group">
                            <label>Equipment Name *</label>
                            <input type="text" id="equipmentName" required>
                        </div>
                        <div class="app-form-group">
                            <label>Type *</label>
                            <select id="equipmentType" required>
                                <option value="">Select Type</option>
                                <option value="Dump Trucks">Dump Trucks</option>
                                <option value="Trucks">Trucks</option>
                                <option value="Trailers">Trailers</option>
                                <option value="Paving">Paving</option>
                                <option value="Skids/Excavation">Skids/Excavation</option>
                                <option value="Rollers">Rollers</option>
                                <option value="Sealcoat">Sealcoat</option>
                                <option value="Crack Fill">Crack Fill</option>
                                <option value="Shop Equipment">Shop Equipment</option>
                                <option value="Small Engine">Small Engine</option>
                                <option value="Misc">Misc</option>
                            </select>
                        </div>
                        <div class="app-form-group">
                            <label>Make</label>
                            <input type="text" id="equipmentMake">
                        </div>
                        <div class="app-form-group">
                            <label>Model</label>
                            <input type="text" id="equipmentModel">
                        </div>
                        <div class="app-form-group">
                            <label>Year</label>
                            <input type="number" id="equipmentYear" min="1900" max="2030">
                        </div>
                        <div class="app-form-group">
                            <label>Status *</label>
                            <select id="equipmentStatus" required>
                                <option value="Active">Active</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Repair">Repair</option>
                                <option value="DOT">DOT</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Add Equipment</button>
                </form>

                <div class="search-filter">
                    <input type="text" id="equipmentSearch" placeholder="Search equipment...">
                    <select id="equipmentFilter">
                        <option value="">All Types</option>
                        <option value="Dump Trucks">Dump Trucks</option>
                        <option value="Trucks">Trucks</option>
                        <option value="Trailers">Trailers</option>
                        <option value="Paving">Paving</option>
                        <option value="Skids/Excavation">Skids/Excavation</option>
                        <option value="Rollers">Rollers</option>
                        <option value="Sealcoat">Sealcoat</option>
                        <option value="Crack Fill">Crack Fill</option>
                        <option value="Shop Equipment">Shop Equipment</option>
                        <option value="Small Engine">Small Engine</option>
                        <option value="Misc">Misc</option>
                    </select>
                    <button class="btn export-btn" onclick="exportData('equipment')">Export</button>
                </div>

                <table class="data-table" id="equipmentTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Make/Model</th>
                            <th>Year</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="maintenance" class="tab-content">
                <h2>Add Maintenance Record</h2>
                <form id="maintenanceForm">
                    <div class="form-grid">
                        <div class="app-form-group">
                            <label>Equipment *</label>
                            <select id="maintenanceEquipment" required>
                                <option value="">Select Equipment</option>
                            </select>
                        </div>
                        <div class="app-form-group">
                            <label>Maintenance Type *</label>
                            <select id="maintenanceType" required>
                                <option value="">Select Type</option>
                                <option value="Oil Change">Oil Change</option>
                                <option value="Tire Replacement">Tire Replacement</option>
                                <option value="Brake Service">Brake Service</option>
                                <option value="Engine Repair">Engine Repair</option>
                                <option value="Transmission Service">Transmission Service</option>
                                <option value="DOT Inspection">DOT Inspection</option>
                                <option value="Preventive Maintenance">Preventive Maintenance</option>
                                <option value="Emergency Repair">Emergency Repair</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="app-form-group">
                            <label>Date Performed *</label>
                            <input type="date" id="maintenanceDate" required>
                        </div>
                        <div class="app-form-group">
                            <label>Cost ($)</label>
                            <input type="number" id="maintenanceCost" step="0.01" min="0">
                        </div>
                        <div class="app-form-group">
                            <label>Technician/Shop</label>
                            <input type="text" id="maintenanceTechnician">
                        </div>
                        <div class="app-form-group" style="grid-column: 1 / -1;">
                            <label>Description/Notes</label>
                            <textarea id="maintenanceDescription" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Add Maintenance Record</button>
                </form>

                <div class="search-filter">
                    <input type="text" id="maintenanceSearch" placeholder="Search maintenance records...">
                    <select id="maintenanceFilterEquipment">
                        <option value="">All Equipment</option>
                    </select>
                    <select id="maintenanceFilterType">
                        <option value="">All Types</option>
                        <option value="Oil Change">Oil Change</option>
                        <option value="Tire Replacement">Tire Replacement</option>
                        <option value="Brake Service">Brake Service</option>
                        <option value="Engine Repair">Engine Repair</option>
                        <option value="Transmission Service">Transmission Service</option>
                        <option value="DOT Inspection">DOT Inspection</option>
                        <option value="Preventive Maintenance">Preventive Maintenance</option>
                        <option value="Emergency Repair">Emergency Repair</option>
                        <option value="Other">Other</option>
                    </select>
                    <button class="btn export-btn" onclick="exportData('maintenance')">Export</button>
                </div>

                <table class="data-table" id="maintenanceTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Equipment</th>
                            <th>Type</th>
                            <th>Cost</th>
                            <th>Technician</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="reports" class="tab-content">
                <h2>Fleet Reports</h2>
                
                <div class="form-grid">
                    <div class="app-form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="maintenance-costs">Maintenance Costs</option>
                            <option value="equipment-status">Equipment Status</option>
                            <option value="maintenance-schedule">Maintenance Schedule</option>
                            <option value="cost-analysis">Cost Analysis</option>
                        </select>
                    </div>
                    <div class="app-form-group">
                        <label>Date Range From</label>
                        <input type="date" id="reportDateFrom">
                    </div>
                    <div class="app-form-group">
                        <label>Date Range To</label>
                        <input type="date" id="reportDateTo">
                    </div>
                    <div class="app-form-group">
                        <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                    </div>
                </div>

                <div id="reportResults"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDbmgbQ3_nOA1M4aZsdEEqXt3u7aGSGNaY",
            authDomain: "fleet-management-system-ddf64.firebaseapp.com",
            projectId: "fleet-management-system-ddf64",
            storageBucket: "fleet-management-system-ddf64.firebasestorage.app",
            messagingSenderId: "243109983757",
            appId: "1:243109983757:web:ea8cc76b897973fee4c744"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let currentCompany = null;
        let currentUser = null;
        let equipmentData = [];
        let maintenanceData = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            
            const today = new Date().toISOString().split('T')[0];
            const maintenanceDateInput = document.getElementById('maintenanceDate');
            if (maintenanceDateInput) {
                maintenanceDateInput.value = today;
            }
            
            setupEventListeners();
        });

        function setupEventListeners() {
            const loginForm = document.getElementById('loginForm');
            const equipmentForm = document.getElementById('equipmentForm');
            const maintenanceForm = document.getElementById('maintenanceForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            if (equipmentForm) {
                equipmentForm.addEventListener('submit', addEquipment);
            }
            
            if (maintenanceForm) {
                maintenanceForm.addEventListener('submit', addMaintenance);
            }
            
            const equipmentSearch = document.getElementById('equipmentSearch');
            const equipmentFilter = document.getElementById('equipmentFilter');
            const maintenanceSearch = document.getElementById('maintenanceSearch');
            const maintenanceFilterEquipment = document.getElementById('maintenanceFilterEquipment');
            const maintenanceFilterType = document.getElementById('maintenanceFilterType');
            
            if (equipmentSearch) equipmentSearch.addEventListener('input', filterEquipment);
            if (equipmentFilter) equipmentFilter.addEventListener('change', filterEquipment);
            if (maintenanceSearch) maintenanceSearch.addEventListener('input', filterMaintenance);
            if (maintenanceFilterEquipment) maintenanceFilterEquipment.addEventListener('change', filterMaintenance);
            if (maintenanceFilterType) maintenanceFilterType.addEventListener('change', filterMaintenance);
        }

        function checkAuthStatus() {
            try {
                const savedAuth = localStorage.getItem('fleetAuth');
                if (savedAuth) {
                    const authData = JSON.parse(savedAuth);
                    currentCompany = authData.company;
                    currentUser = authData.user;
                    showMainApp();
                } else {
                    showLoginPage();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('companyName').textContent = currentCompany;
            document.getElementById('userName').textContent = currentUser;
            
            loadData();
            updateDashboard();
            updateEquipmentDropdowns();
            
            showNotification('success', 'Welcome!', `Welcome back to ${currentCompany}!`);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const companyCode = document.getElementById('companyCode').value;
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                currentCompany = companyCode;
                currentUser = email;
                
                localStorage.setItem('fleetAuth', JSON.stringify({
                    company: currentCompany,
                    user: currentUser
                }));
                
                showMainApp();
            } catch (error) {
                console.error('Login error:', error);
                showNotification('error', 'Login Failed', 'Invalid credentials');
            }
        }

        window.logout = function() {
            localStorage.removeItem('fleetAuth');
            currentCompany = null;
            currentUser = null;
            equipmentData = [];
            maintenanceData = [];
            showLoginPage();
        }

        async function loadData() {
            try {
                const equipmentQuery = query(
                    collection(db, 'companies', currentCompany, 'equipment')
                );
                const equipmentSnapshot = await getDocs(equipmentQuery);
                
                equipmentData = [];
                equipmentSnapshot.forEach(doc => {
                    equipmentData.push({ id: doc.id, ...doc.data() });
                });
                
                const maintenanceQuery = query(
                    collection(db, 'companies', currentCompany, 'maintenance'),
                    orderBy('date', 'desc')
                );
                const maintenanceSnapshot = await getDocs(maintenanceQuery);
                
                maintenanceData = [];
                maintenanceSnapshot.forEach(doc => {
                    maintenanceData.push({ id: doc.id, ...doc.data() });
                });
                
                displayEquipment();
                displayMaintenance();
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('error', 'Error', 'Failed to load data from database');
            }
        }

        async function saveEquipmentToFirebase(equipmentItem) {
            try {
                await addDoc(collection(db, 'companies', currentCompany, 'equipment'), equipmentItem);
                showNotification('success', 'Success', 'Equipment added successfully');
                loadData();
            } catch (error) {
                console.error('Error saving equipment:', error);
                showNotification('error', 'Error', 'Failed to save equipment');
            }
        }

        async function saveMaintenanceToFirebase(maintenanceItem) {
            try {
                await addDoc(collection(db, 'companies', currentCompany, 'maintenance'), maintenanceItem);
                showNotification('success', 'Success', 'Maintenance record added successfully');
                loadData();
            } catch (error) {
                console.error('Error saving maintenance:', error);
                showNotification('error', 'Error', 'Failed to save maintenance record');
            }
        }

        async function deleteEquipmentFromFirebase(equipmentId) {
            try {
                await deleteDoc(doc(db, 'companies', currentCompany, 'equipment', equipmentId));
                showNotification('success', 'Success', 'Equipment deleted successfully');
                loadData();
            } catch (error) {
                console.error('Error deleting equipment:', error);
                showNotification('error', 'Error', 'Failed to delete equipment');
            }
        }

        async function deleteMaintenanceFromFirebase(maintenanceId) {
            try {
                await deleteDoc(doc(db, 'companies', currentCompany, 'maintenance', maintenanceId));
                showNotification('success', 'Success', 'Maintenance record deleted successfully');
                loadData();
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                showNotification('error', 'Error', 'Failed to delete maintenance record');
            }
        }

        async function addEquipment(event) {
            event.preventDefault();
            
            const equipmentItem = {
                equipmentId: document.getElementById('equipmentId').value,
                name: document.getElementById('equipmentName').value,
                type: document.getElementById('equipmentType').value,
                make: document.getElementById('equipmentMake').value || '',
                model: document.getElementById('equipmentModel').value || '',
                year: document.getElementById('equipmentYear').value || '',
                status: document.getElementById('equipmentStatus').value,
                dateAdded: new Date().toISOString(),
                addedBy: currentUser
            };
            
            await saveEquipmentToFirebase(equipmentItem);
            document.getElementById('equipmentForm').reset();
        }

        async function addMaintenance(event) {
            event.preventDefault();
            
            const maintenanceItem = {
                equipmentId: document.getElementById('maintenanceEquipment').value,
                type: document.getElementById('maintenanceType').value,
                date: document.getElementById('maintenanceDate').value,
                cost: parseFloat(document.getElementById('maintenanceCost').value) || 0,
                technician: document.getElementById('maintenanceTechnician').value || '',
                description: document.getElementById('maintenanceDescription').value || '',
                dateAdded: new Date().toISOString(),
                addedBy: currentUser
            };
            
            await saveMaintenanceToFirebase(maintenanceItem);
            
            document.getElementById('maintenanceForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('maintenanceDate').value = today;
        }

        function displayEquipment() {
            const tbody = document.querySelector('#equipmentTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            equipmentData.forEach((equipment) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${equipment.equipmentId || ''}</td>
                    <td>${equipment.name || ''}</td>
                    <td>${equipment.type || ''}</td>
                    <td>${(equipment.make || '') + ' ' + (equipment.model || '')}</td>
                    <td>${equipment.year || '-'}</td>
                    <td><span class="status ${(equipment.status || '').toLowerCase()}">${equipment.status || ''}</span></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteEquipment('${equipment.id}')" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
            });
        }

        function displayMaintenance() {
            const tbody = document.querySelector('#maintenanceTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            maintenanceData.forEach((maintenance) => {
                const equipment = equipmentData.find(eq => eq.id === maintenance.equipmentId);
                const equipmentName = equipment ? equipment.name : 'Unknown Equipment';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(maintenance.date).toLocaleDateString()}</td>
                    <td>${equipmentName}</td>
                    <td>${maintenance.type || ''}</td>
                    <td>${(maintenance.cost || 0).toFixed(2)}</td>
                    <td>${maintenance.technician || '-'}</td>
                    <td>${maintenance.description || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMaintenance('${maintenance.id}')" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
            });
            
            updateRecentMaintenance();
        }

        function updateRecentMaintenance() {
            const tbody = document.querySelector('#recentMaintenanceTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const recentMaintenance = maintenanceData.slice(0, 5);
            
            recentMaintenance.forEach(maintenance => {
                const equipment = equipmentData.find(eq => eq.id === maintenance.equipmentId);
                const equipmentName = equipment ? equipment.name : 'Unknown Equipment';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${equipmentName}</td>
                    <td>${maintenance.type || ''}</td>
                    <td>${new Date(maintenance.date).toLocaleDateString()}</td>
                    <td>${(maintenance.cost || 0).toFixed(2)}</td>
                    <td><span class="status active">Completed</span></td>
                `;
            });
        }

        window.deleteEquipment = async function(equipmentId) {
            if (confirm('Are you sure you want to delete this equipment?')) {
                await deleteEquipmentFromFirebase(equipmentId);
            }
        }

        window.deleteMaintenance = async function(maintenanceId) {
            if (confirm('Are you sure you want to delete this maintenance record?')) {
                await deleteMaintenanceFromFirebase(maintenanceId);
            }
        }

        function updateDashboard() {
            document.getElementById('totalEquipment').textContent = equipmentData.length;
            document.getElementById('activeEquipment').textContent = equipmentData.filter(eq => eq.status === 'Active').length;
            document.getElementById('maintenanceDue').textContent = equipmentData.filter(eq => eq.status === 'Maintenance').length;
            document.getElementById('totalMaintenanceRecords').textContent = maintenanceData.length;
        }

        function updateEquipmentDropdowns() {
            const maintenanceEquipmentSelect = document.getElementById('maintenanceEquipment');
            const maintenanceFilterEquipment = document.getElementById('maintenanceFilterEquipment');
            
            if (maintenanceEquipmentSelect) {
                maintenanceEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>';
                equipmentData.forEach(equipment => {
                    const option = document.createElement('option');
                    option.value = equipment.id;
                    option.textContent = equipment.name;
                    maintenanceEquipmentSelect.appendChild(option);
                });
            }
            
            if (maintenanceFilterEquipment) {
                maintenanceFilterEquipment.innerHTML = '<option value="">All Equipment</option>';
                equipmentData.forEach(equipment => {
                    const option = document.createElement('option');
                    option.value = equipment.id;
                    option.textContent = equipment.name;
                    maintenanceFilterEquipment.appendChild(option);
                });
            }
        }

        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function filterEquipment() {
            const searchTerm = (document.getElementById('equipmentSearch').value || '').toLowerCase();
            const filterType = document.getElementById('equipmentFilter').value;
            
            const filteredData = equipmentData.filter(equipment => {
                const matchesSearch = (equipment.name || '').toLowerCase().includes(searchTerm) ||
                                    (equipment.equipmentId || '').toLowerCase().includes(searchTerm) ||
                                    (equipment.make || '').toLowerCase().includes(searchTerm) ||
                                    (equipment.model || '').toLowerCase().includes(searchTerm);
                
                const matchesFilter = !filterType || equipment.type === filterType;
                
                return matchesSearch && matchesFilter;
            });
            
            displayFilteredEquipment(filteredData);
        }

        function displayFilteredEquipment(filteredData) {
            const tbody = document.querySelector('#equipmentTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            filteredData.forEach((equipment) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${equipment.equipmentId || ''}</td>
                    <td>${equipment.name || ''}</td>
                    <td>${equipment.type || ''}</td>
                    <td>${(equipment.make || '') + ' ' + (equipment.model || '')}</td>
                    <td>${equipment.year || '-'}</td>
                    <td><span class="status ${(equipment.status || '').toLowerCase()}">${equipment.status || ''}</span></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteEquipment('${equipment.id}')" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
            });
        }

        function filterMaintenance() {
            const searchTerm = (document.getElementById('maintenanceSearch').value || '').toLowerCase();
            const filterEquipment = document.getElementById('maintenanceFilterEquipment').value;
            const filterType = document.getElementById('maintenanceFilterType').value;
            
            const filteredData = maintenanceData.filter(maintenance => {
                const equipment = equipmentData.find(eq => eq.id === maintenance.equipmentId);
                const equipmentName = equipment ? (equipment.name || '') : '';
                
                const matchesSearch = equipmentName.toLowerCase().includes(searchTerm) ||
                                    (maintenance.type || '').toLowerCase().includes(searchTerm) ||
                                    (maintenance.technician || '').toLowerCase().includes(searchTerm) ||
                                    (maintenance.description || '').toLowerCase().includes(searchTerm);
                
                const matchesEquipment = !filterEquipment || maintenance.equipmentId === filterEquipment;
                const matchesType = !filterType || maintenance.type === filterType;
                
                return matchesSearch && matchesEquipment && matchesType;
            });
            
            displayFilteredMaintenance(filteredData);
        }

        function displayFilteredMaintenance(filteredData) {
            const tbody = document.querySelector('#maintenanceTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            filteredData.forEach((maintenance) => {
                const equipment = equipmentData.find(eq => eq.id === maintenance.equipmentId);
                const equipmentName = equipment ? equipment.name : 'Unknown Equipment';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(maintenance.date).toLocaleDateString()}</td>
                    <td>${equipmentName}</td>
                    <td>${maintenance.type || ''}</td>
                    <td>${(maintenance.cost || 0).toFixed(2)}</td>
                    <td>${maintenance.technician || '-'}</td>
                    <td>${maintenance.description || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMaintenance('${maintenance.id}')" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
            });
        }

        window.exportData = function(type) {
            let data, filename, headers;
            
            if (type === 'equipment') {
                data = equipmentData;
                filename = `${currentCompany}_equipment_${new Date().toISOString().split('T')[0]}.csv`;
                headers = ['Equipment ID', 'Name', 'Type', 'Make', 'Model', 'Year', 'Status'];
            } else if (type === 'maintenance') {
                data = maintenanceData.map(maintenance => {
                    const equipment = equipmentData.find(eq => eq.id === maintenance.equipmentId);
                    return {
                        ...maintenance,
                        equipmentName: equipment ? equipment.name : 'Unknown Equipment'
                    };
                });
                filename = `${currentCompany}_maintenance_${new Date().toISOString().split('T')[0]}.csv`;
                headers = ['Date', 'Equipment', 'Type', 'Cost', 'Technician', 'Description'];
            }
            
            downloadCSV(data, headers, filename, type);
        }

        function downloadCSV(data, headers, filename, type) {
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                let row = [];
                if (type === 'equipment') {
                    row = [
                        item.equipmentId || '',
                        item.name || '',
                        item.type || '',
                        item.make || '',
                        item.model || '',
                        item.year || '',
                        item.status || ''
                    ];
                } else if (type === 'maintenance') {
                    row = [
                        item.date || '',
                        item.equipmentName || '',
                        item.type || '',
                        item.cost || 0,
                        item.technician || '',
                        item.description || ''
                    ];
                }
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.generateReport = function() {
            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            
            let reportData = maintenanceData;
            
            if (dateFrom || dateTo) {
                reportData = maintenanceData.filter(maintenance => {
                    const maintenanceDate = new Date(maintenance.date);
                    const fromDate = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
                    const toDate = dateTo ? new Date(dateTo) : new Date();
                    
                    return maintenanceDate >= fromDate && maintenanceDate <= toDate;
                });
            }
            
            generateReportDisplay(reportType, reportData);
        }

        function generateReportDisplay(reportType, data) {
            const resultsDiv = document.getElementById('reportResults');
            if (!resultsDiv) return;
            
            switch (reportType) {
                case 'maintenance-costs':
                    const totalCost = data.reduce((sum, item) => sum + (item.cost || 0), 0);
                    const avgCost = data.length > 0 ? totalCost / data.length : 0;
                    
                    resultsDiv.innerHTML = `
                        <h3>Maintenance Cost Report</h3>
                        <div class="dashboard-stats">
                            <div class="stat-card">
                                <h3>${totalCost.toFixed(2)}</h3>
                                <p>Total Maintenance Cost</p>
                            </div>
                            <div class="stat-card">
                                <h3>${avgCost.toFixed(2)}</h3>
                                <p>Average Cost per Job</p>
                            </div>
                            <div class="stat-card">
                                <h3>${data.length}</h3>
                                <p>Total Maintenance Jobs</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'equipment-status':
                    const statusCounts = {};
                    equipmentData.forEach(equipment => {
                        const status = equipment.status || 'Unknown';
                        statusCounts[status] = (statusCounts[status] || 0) + 1;
                    });
                    
                    let statusReport = '<h3>Equipment Status Report</h3><div class="dashboard-stats">';
                    for (const [status, count] of Object.entries(statusCounts)) {
                        statusReport += `
                            <div class="stat-card">
                                <h3>${count}</h3>
                                <p>${status} Equipment</p>
                            </div>
                        `;
                    }
                    statusReport += '</div>';
                    resultsDiv.innerHTML = statusReport;
                    break;
                    
                default:
                    resultsDiv.innerHTML = '<p>Report generated successfully. More detailed reports coming soon!</p>';
            }
        }

        function showNotification(type, title, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
